<!doctype html>
<html>
  <head>
    <script>
      // Server-side data injected by Apps Script
      const CHAT_ID = <?!= chatId || 'null' ?>;
      const INITIAL_MESSAGES = <?!= messages || '[]' ?>;
    </script>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #0f172a;
        color: white;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-size: 13px;
      }

      #container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-sizing: border-box;
      }

      .chat-box {
        border-radius: 10px;
        padding: 8px;
        margin: 6px 0;
        max-width: 80%;
        word-break: break-word;
        font-size: 0.9rem;
      }

      .user {
        text-align: right;
        margin-left: auto;
        background: #1d4ed8;
        color: white;
        border-bottom-right-radius: 4px;
        border-bottom-left-radius: 12px;
      }

      .bot {
        text-align: left;
        margin-right: auto;
        background: #1f2937;
        color: white;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 12px;
      }

      #chat {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 12px;
        display: flex;
        flex-direction: column;
      }

      #input-area {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        padding-top: 12px;
        border-top: 1px solid rgba(148, 163, 184, 0.3);
        align-items: center;
      }

      #chat-input-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        gap: 8px;
      }

      #user-input {
        width: 100%;
        text-align: left;
        min-height: 60px;
        max-height: 160px;
        resize: none;
        overflow-y: auto;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid #334155;
        background: #535353;
        color: #ffffff;
        font-size: 1rem;
        box-sizing: border-box;
        transition: height 0.1s ease;
        font-size: 0.9rem;
      }

      .btn-row {
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 8px;
      }

      .btn {
        width: 50%;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.7rem;
        min-width: 80px;
        height: 30px;
      }

      #select-btn {
        background: #1f2937;
      }
      #add-target-btn {
        background: #059669;
      }
      #send-btn {
        background: #1d4ed8;
      }
    </style>
  </head>
  <body>
    <div id="container">
      <div id="chat"></div>

      <div id="input-area">
        <div id="chat-input-group">
          <textarea
            id="user-input"
            placeholder="Ask something..."
            aria-label="Message input"
          ></textarea>
          <div class="btn-row">
            <button id="select-btn" class="btn" onclick="addRangeTag('cells', 'Selected range')">
              Select Context
            </button>
            <button id="add-target-btn" class="btn" onclick="addRangeTag('target', 'Added target')">
              Add Target
            </button>
          </div>
          <div class="btn-row">
            <button id="send-btn" class="btn" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    /**
     * Appends a message to the chat display area
     * @param {string} text - The message text to display
     * @param {string} sender - The sender type ('user' or 'bot') for styling
     */
    function appendMessage(text, sender) {
      const div = document.createElement('div');
      div.className = `chat-box ${sender}`;
      div.textContent = text;
      const chat = document.getElementById('chat');
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    /**
     * Load initial messages when the page loads
     */
    if (typeof INITIAL_MESSAGES !== 'undefined' && Array.isArray(INITIAL_MESSAGES)) {
      INITIAL_MESSAGES.forEach(function (msg) {
        const sender = msg.is_from_user ? 'user' : 'bot';
        appendMessage(msg.content, sender);
      });
    }

    const input = document.getElementById('user-input');
    input.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 160) + 'px';
    });

    /**
     * Appends text to the input field and triggers resize
     * @param {string} str - The string to append to the input field
     */
    function appendToInput(str) {
      input.value += str;
      input.dispatchEvent(new Event('input'));
      input.focus();
    }

    /**
     * Gets the currently selected range from the spreadsheet and adds it to the input with specified tag
     * @param {string} tagType - The tag type ('cells' for context or 'target' for output destination)
     * @param {string} messagePrefix - The prefix for the success message
     */
    function addRangeTag(tagType, messagePrefix) {
      const buttonId = tagType === 'cells' ? 'select-btn' : 'add-target-btn';
      const button = document.getElementById(buttonId);
      button.disabled = true;

      google.script.run
        .withSuccessHandler(function (selection) {
          button.disabled = false;
          if (!selection) {
            appendMessage('No range selected in the spreadsheet.', 'bot');
            return;
          }

          const sheetName = selection.sheetName;
          const range = selection.activeRange;
          const rangeTag = `<${tagType}>'${sheetName}'!${range}</${tagType}>`;
          appendToInput(rangeTag);
          appendMessage(`${messagePrefix}: ${range}`, 'bot');
        })
        .withFailureHandler(function (error) {
          button.disabled = false;
          appendMessage(`Error: ${error.message || error}`, 'bot');
        })
        .getActiveRangeA1Notation();
    }

    /**
     * Sends the user's message to the backend for processing
     * Displays the user message, clears the input, and shows the bot's response
     */
    function sendMessage() {
      const sendBtn = document.getElementById('send-btn');
      const message = input.value.trim();
      if (!message) return;

      if (typeof CHAT_ID === 'undefined' || CHAT_ID === null) {
        appendMessage('Error: No chat ID available', 'bot');
        return;
      }

      appendMessage(message, 'user');
      input.value = '';
      input.style.height = '60px';

      google.script.run
        .withSuccessHandler(function (response) {
          appendMessage(response.reply, 'bot');
        })
        .withFailureHandler(function (error) {
          appendMessage(`Error: ${error.message || error}`, 'bot');
        })
        .handleMessage(message, CHAT_ID);
    }
  </script>
</html>
