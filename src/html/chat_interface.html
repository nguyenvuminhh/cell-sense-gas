<!doctype html>
<html>
  <head>
    <script>
      // Server-side data injected by Apps Script
      const CHAT_ID = <?!= chatId || 'null' ?>;
      const INITIAL_MESSAGES = <?!= messages || '[]' ?>;
    </script>
    <base target="_top" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #0f172a;
        color: white;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-size: 13px;
        overflow: hidden;
      }

      #announcement {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        padding: 12px 20px;
        text-align: center;
        font-size: 0.9rem;
        z-index: 100;
        transform: translateY(-100%);
        transition: transform 0.3s ease;
      }

      #announcement.show {
        transform: translateY(0);
      }

      #announcement.error {
        background: #dc2626;
        color: white;
      }

      #announcement.success {
        background: #059669;
        color: white;
      }

      #announcement.info {
        background: #3b82f6;
        color: white;
      }

      #container {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-box {
        border-radius: 10px;
        padding: 8px;
        margin: 6px 0;
        max-width: 80%;
        word-break: break-word;
        font-size: 0.9rem;
      }

      .user {
        text-align: right;
        margin-left: auto;
        background: #1d4ed8;
        color: white;
        border-bottom-right-radius: 4px;
        border-bottom-left-radius: 12px;
      }

      .bot {
        text-align: left;
        margin-right: auto;
        background: #1f2937;
        color: white;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 12px;
      }

      .revert-btn {
        background: #dc2626;
        color: white;
        border: none;
        border-radius: 4px;
        padding: 4px 8px;
        margin-top: 6px;
        cursor: pointer;
        font-size: 0.7rem;
      }

      .revert-btn:hover {
        background: #b91c1c;
      }

      .revert-btn:disabled {
        background: #6b7280;
        cursor: not-allowed;
      }

      #chat {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        padding-bottom: 12px;
        display: flex;
        flex-direction: column;
      }

      #input-area {
        position: sticky;
        bottom: 0;
        display: flex;
        flex-direction: column;
        padding: 12px 20px;
        background: #0f172a;
        border-top: 1px solid rgba(148, 163, 184, 0.3);
        align-items: center;
        z-index: 10;
      }

      #chat-input-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        gap: 8px;
      }

      #user-input {
        width: 100%;
        text-align: left;
        min-height: 60px;
        max-height: 160px;
        resize: none;
        overflow-y: auto;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid #334155;
        background: #535353;
        color: #ffffff;
        font-size: 1rem;
        box-sizing: border-box;
        transition: height 0.1s ease;
        font-size: 0.9rem;
      }

      .btn-row {
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 8px;
      }

      .btn {
        width: 50%;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.7rem;
        min-width: 80px;
        height: 28px;
      }

      #model-selector {
        flex: 1;
        background: #374151;
        color: white;
        border: 1px solid #4b5563;
        border-radius: 8px;
        padding: 8px 12px;
        font-size: 0.7rem;
        cursor: pointer;
        height: 28px;
      }

      #model-selector:focus {
        outline: none;
        border-color: #3b82f6;
      }

      #select-btn {
        background: #059669;
      }
      #add-target-btn {
        background: #059669;
      }
      #send-btn {
        background: #1d4ed8;
      }

      .loading-indicator {
        display: flex;
        align-items: center;
        gap: 4px;
        padding: 8px 12px;
        background: #1f2937;
        border-radius: 10px;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 12px;
        margin: 6px 0;
        max-width: 80%;
        font-size: 0.9rem;
        color: #94a3b8;
      }

      .loading-dots {
        min-width: 18px;
        text-align: left;
      }
    </style>
  </head>
  <body>
    <div id="announcement"></div>
    <div id="container">
      <div id="chat"></div>

      <div id="input-area">
        <div id="chat-input-group">
          <div class="btn-row">
            <button id="select-btn" class="btn" onclick="addRangeTag('cells', 'Selected range')">
              Select Context
            </button>
            <button id="add-target-btn" class="btn" onclick="addRangeTag('target', 'Added target')">
              Add Target
            </button>
          </div>
          <textarea
            id="user-input"
            placeholder="Ask something..."
            aria-label="Message input"
          ></textarea>
          <div class="btn-row">
            <select id="model-selector" aria-label="Model selection">
              <option value="" disabled selected>Loading models...</option>
            </select>
            <button id="send-btn" class="btn" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>
    </div>
  </body>
  <script>
    /**
     * Shows a time-limited announcement at the top of the page
     * @param {string} message - The message to display
     * @param {string} type - The type of announcement ('error', 'success', or 'info')
     * @param {number} duration - Duration in milliseconds (default: 3000)
     */
    function showAnnouncement(message, type = 'info', duration = 3000) {
      const announcement = document.getElementById('announcement');
      announcement.textContent = message;
      announcement.className = `show ${type}`;

      setTimeout(function () {
        announcement.className = announcement.className.replace('show', '');
      }, duration);
    }

    // Store saved ranges for revert functionality
    let lastSavedRanges = null;
    let revertMessageId = 0;

    /**
     * Appends a message to the chat display area
     * @param {string} text - The message text to display
     * @param {string} sender - The sender type ('user' or 'bot') for styling
     * @param {Array|null} savedRanges - Optional saved ranges for revert functionality
     */
    function appendMessage(text, sender, savedRanges = null) {
      const div = document.createElement('div');
      div.className = `chat-box ${sender}`;

      const textSpan = document.createElement('span');
      textSpan.textContent = text;
      div.appendChild(textSpan);

      if (sender === 'bot' && savedRanges && savedRanges.length > 0) {
        revertMessageId++;
        const currentMessageId = revertMessageId;
        const revertBtn = document.createElement('button');
        revertBtn.className = 'revert-btn';
        revertBtn.textContent = 'Revert Edit';
        revertBtn.dataset.messageId = currentMessageId;
        revertBtn.onclick = function () {
          revertEdits(savedRanges, revertBtn);
        };
        div.appendChild(document.createElement('br'));
        div.appendChild(revertBtn);
      }

      const chat = document.getElementById('chat');
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    /**
     * Reverts cell edits to their previous values
     * @param {Array} savedRanges - The saved ranges to restore
     * @param {HTMLElement} button - The revert button element
     */
    function revertEdits(savedRanges, button) {
      button.disabled = true;
      button.textContent = 'Reverting...';

      google.script.run
        .withSuccessHandler(function (response) {
          if (response.success) {
            button.textContent = 'Reverted';
            showAnnouncement('Cells reverted to previous values', 'success');
          } else {
            button.disabled = false;
            button.textContent = 'Revert Edit';
            showAnnouncement('Failed to revert: ' + (response.error || 'Unknown error'), 'error');
          }
        })
        .withFailureHandler(function (error) {
          button.disabled = false;
          button.textContent = 'Revert Edit';
          showAnnouncement('Failed to revert: ' + (error.message || error), 'error');
        })
        .revertCellEdits(savedRanges);
    }

    /**
     * Load initial messages when the page loads
     */
    if (typeof INITIAL_MESSAGES !== 'undefined' && Array.isArray(INITIAL_MESSAGES)) {
      INITIAL_MESSAGES.forEach(function (msg) {
        const sender = msg.is_from_user ? 'user' : 'bot';
        appendMessage(msg.content, sender);
      });
    }

    /**
     * Load supported models from the backend and populate the model selector
     */
    function loadSupportedModels() {
      google.script.run
        .withSuccessHandler(function (response) {
          const selector = document.getElementById('model-selector');
          selector.innerHTML = '';

          const providers = Object.keys(response);

          if (providers.length === 0) {
            selector.innerHTML = `<option value="" disabled selected>No models available ${JSON.stringify(
              response,
            )}</option>`;
            return;
          }

          let isFirst = true;
          providers.forEach(function (provider) {
            const models = response[provider] || [];
            models.forEach(function (modelId) {
              const option = document.createElement('option');
              option.value = modelId;
              option.textContent = modelId;
              option.provider = provider;
              if (isFirst) {
                option.selected = true;
                isFirst = false;
              }
              selector.appendChild(option);
            });
          });
        })
        .withFailureHandler(function (error) {
          const selector = document.getElementById('model-selector');
          selector.innerHTML = '<option value="" disabled selected>Error loading models</option>';
          showAnnouncement('Error loading models: ' + (error.message || error), 'error');
        })
        .getSupportedModels();
    }

    // Load models on page load
    loadSupportedModels();

    const input = document.getElementById('user-input');
    input.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 160) + 'px';
    });

    /**
     * Appends text to the input field and triggers resize
     * @param {string} str - The string to append to the input field
     */
    function appendToInput(str) {
      input.value += str;
      input.dispatchEvent(new Event('input'));
      input.focus();
    }

    /**
     * Gets the currently selected range from the spreadsheet and adds it to the input with specified tag
     * @param {string} tagType - The tag type ('cells' for context or 'target' for output destination)
     * @param {string} messagePrefix - The prefix for the success message
     */
    function addRangeTag(tagType, messagePrefix) {
      const buttonId = tagType === 'cells' ? 'select-btn' : 'add-target-btn';
      const button = document.getElementById(buttonId);
      button.disabled = true;

      google.script.run
        .withSuccessHandler(function (selection) {
          button.disabled = false;
          if (!selection) {
            showAnnouncement('No range selected in the spreadsheet.', 'error');
            return;
          }

          const sheetName = selection.sheetName;
          const range = selection.activeRange;
          const rangeTag = `<${tagType}>'${sheetName}'!${range}</${tagType}>`;
          appendToInput(rangeTag);
          showAnnouncement(`${messagePrefix}: ${range}`, 'success');
        })
        .withFailureHandler(function (error) {
          button.disabled = false;
          showAnnouncement(`Error: ${error.message || error}`, 'error');
        })
        .getActiveRangeA1Notation();
    }

    // Loading phrases for the animated indicator
    const loadingPhrases = [
      'Thinking',
      'Processing',
      'Working on it',
      'Calculating',
      'Analyzing',
      'Checking',
      'Loading',
      'Preparing response',
      'Considering',
      'Contemplating',
      'Reflecting',
      'Reviewing',
      'Evaluating',
      'Taking a moment',
      'Let me think',
      'Gathering thoughts',
      'Computing',
      'Running inference',
      'Executing logic',
      'Parsing input',
      'Synthesizing answer',
      'Optimizing response',
      'Resolving query',
      'Generating output',
      'One moment',
      'Just a sec',
      'Hang tight',
      'Almost there',
      'Give me a moment',
      'Let me check',
      'On it',
      'Brain gears turning',
      'Crunching the numbers',
      'Consulting the neurons',
      'Asking my inner AI',
      'Booting brain cells',
      'Thinking very hard',
      'Summoning wisdom',
      'Please wait',
      'Hold on',
      'Working',
      'Processing request',
      'Deliberating',
      'Formulating response',
      'Assessing information',
      'Conducting analysis',
      'Reviewing context',
      'Inferring outcome',
    ];

    let loadingElement = null;
    let loadingInterval = null;

    /**
     * Shows the loading indicator with animated dots
     */
    function showLoadingIndicator() {
      const chat = document.getElementById('chat');
      const phrase = loadingPhrases[Math.floor(Math.random() * loadingPhrases.length)];

      loadingElement = document.createElement('div');
      loadingElement.className = 'loading-indicator';
      loadingElement.innerHTML = `<span class="loading-text">${phrase}</span><span class="loading-dots"></span>`;

      chat.appendChild(loadingElement);
      chat.scrollTop = chat.scrollHeight;

      const dotsElement = loadingElement.querySelector('.loading-dots');
      let dotCount = 0;

      loadingInterval = setInterval(function () {
        dotCount = (dotCount + 1) % 4;
        dotsElement.textContent = '.'.repeat(dotCount);
      }, 400);
    }

    /**
     * Hides and removes the loading indicator
     */
    function hideLoadingIndicator() {
      if (loadingInterval) {
        clearInterval(loadingInterval);
        loadingInterval = null;
      }
      if (loadingElement) {
        loadingElement.remove();
        loadingElement = null;
      }
    }

    /**
     * Sends the user's message to the backend for processing
     * Displays the user message, clears the input, and shows the bot's response
     */
    function sendMessage() {
      const sendBtn = document.getElementById('send-btn');
      const modelSelector = document.getElementById('model-selector');
      const message = input.value.trim();
      if (!message) return;

      if (typeof CHAT_ID === 'undefined' || CHAT_ID === null) {
        showAnnouncement('Error: No chat ID available', 'error');
        return;
      }

      const selectedModel = modelSelector.value;
      const selectedProvider = modelSelector.options[modelSelector.selectedIndex].provider;
      appendMessage(message, 'user');
      input.value = '';
      input.style.height = '60px';

      showLoadingIndicator();

      google.script.run
        .withSuccessHandler(function (response) {
          hideLoadingIndicator();
          if (response.error) {
            showAnnouncement(`Error: ${response.error}`, 'error', 5000);
          } else {
            appendMessage(response.reply, 'bot', response.savedRanges);
          }
        })
        .withFailureHandler(function (error) {
          hideLoadingIndicator();
          showAnnouncement(`Error: ${error.message || error}`, 'error', 5000);
        })
        .handleMessage(message, CHAT_ID, selectedModel, selectedProvider);
    }
  </script>
</html>
