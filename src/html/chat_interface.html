<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        background: #0f172a;
        color: white;
        height: 100vh;
        display: flex;
        flex-direction: column;
        font-size: 13px;
      }

      #container {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 20px;
        box-sizing: border-box;
      }

      .chat-box {
        border-radius: 10px;
        padding: 8px;
        margin: 6px 0;
        max-width: 80%;
        word-break: break-word;
        font-size: 0.9rem;
      }

      .user {
        text-align: right;
        margin-left: auto;
        background: #1d4ed8;
        color: white;
        border-bottom-right-radius: 4px;
        border-bottom-left-radius: 12px;
      }

      .bot {
        text-align: left;
        margin-right: auto;
        background: #1f2937;
        color: white;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 12px;
      }

      #chat {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 12px;
        display: flex;
        flex-direction: column;
      }

      #input-area {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        padding-top: 12px;
        border-top: 1px solid rgba(148, 163, 184, 0.3);
        align-items: center;
      }

      #chat-input-group {
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        gap: 8px;
      }

      #user-input {
        width: 100%;
        text-align: left;
        min-height: 60px;
        max-height: 160px;
        resize: none;
        overflow-y: auto;
        padding: 10px;
        border-radius: 12px;
        border: 1px solid #334155;
        background: #535353;
        color: #ffffff;
        font-size: 1rem;
        box-sizing: border-box;
        transition: height 0.1s ease;
        font-size: 0.9rem;
      }

      .btn-row {
        width: 100%;
        display: flex;
        justify-content: center;
        gap: 8px;
      }

      .btn {
        width: 50%;
        color: white;
        border: none;
        border-radius: 8px;
        padding: 8px 16px;
        cursor: pointer;
        font-size: 0.7rem;
        min-width: 80px;
        height: 30px;
      }

      #select-btn {
        background: #1f2937;
      }
      #add-target-btn {
        background: #059669;
      }
      #send-btn {
        background: #1d4ed8;
      }

    </style>
  </head>
  <body>
    <div id="container">
      <div id="chat"></div>

      <div id="input-area">
        <div id="chat-input-group">
          <textarea id="user-input" placeholder="Ask something..." aria-label="Message input"></textarea>
          <div class="btn-row">
            <button id="select-btn" class="btn" onclick="fillSelectedRange()">Select Context</button>
            <button id="add-target-btn" class="btn" onclick="addTargetCell()">Add Target</button>
          </div>
          <div class="btn-row">
            <button id="send-btn" class="btn" onclick="sendMessage()">Send</button>
          </div>
        </div>
      </div>
    </div>

    <script>
      function appendMessage(text, sender) {
        const div = document.createElement('div');
        div.className = `chat-box ${sender}`;
        div.textContent = text;
        const chat = document.getElementById('chat');
        chat.appendChild(div);
        chat.scrollTop = chat.scrollHeight;
      }

      const input = document.getElementById('user-input');
      input.addEventListener('input', function () {
        this.style.height = 'auto';
        this.style.height = Math.min(this.scrollHeight, 160) + 'px';
      });

      function appendToInput(str) {
        input.value += str;
        input.dispatchEvent(new Event('input'));
        input.focus();
      }

      function fillSelectedRange() {
        const selectBtn = document.getElementById('select-btn');
        selectBtn.disabled = true;

        google.script.run
          .withSuccessHandler(function (selection) {
            selectBtn.disabled = false;
            if (!selection) {
              appendMessage('No range selected in the spreadsheet.', 'bot');
              return;
            }

            const sheetName = selection.sheetName;
            const range = selection.activeRange;
            const rangeTag = `<cells>'${sheetName}'!${range}</cells>`;
            appendToInput(rangeTag);
            appendMessage('Selected range: ' + range, 'bot');
          })
          .withFailureHandler(function (error) {
            selectBtn.disabled = false;
            appendMessage(`Error: ${error.message || error}`, 'bot');
          })
          .getActiveRangeA1Notation();
      }

      function addTargetCell() {
        const addTargetBtn = document.getElementById('add-target-btn');
        addTargetBtn.disabled = true;

        google.script.run
          .withSuccessHandler(function (selection) {
            addTargetBtn.disabled = false;
            if (!selection) {
              appendMessage('No range selected in the spreadsheet.', 'bot');
              return;
            }

            const sheetName = selection.sheetName;
            const range = selection.activeRange;
            const targetTag = `<target>'${sheetName}'!${range}</target>`;
            appendToInput(targetTag);
            appendMessage('Added target: ' + range, 'bot');
          })
          .withFailureHandler(function (error) {
            addTargetBtn.disabled = false;
            appendMessage(`Error: ${error.message || error}`, 'bot');
          })
          .getActiveRangeA1Notation();
      }

      function sendMessage() {
        const sendBtn = document.getElementById('send-btn');
        const message = input.value.trim();
        if (!message) return;

        appendMessage(message, 'user');
        input.value = '';
        input.style.height = '60px';

        google.script.run
          .withSuccessHandler(function (response) {
            appendMessage(response.reply, 'bot');
          })
          .withFailureHandler(function (error) {
            appendMessage(`Error: ${error.message || error}`, 'bot');
          })
          .handleMessage(message);
      }
    </script>
  </body>
</html>
